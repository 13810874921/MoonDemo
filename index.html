<!doctype html>
<html>
<head>
  <title>WebGL Moon Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <noscript>
    Sorry, you need javascript enabled to view this web application. 
    Please check your browser's settings if you wish to run the app.
  </noscript>

  <link type="text/css" href="css/main.css" rel="stylesheet" />

  <!-- Include vendor scripts, jQuery, and Three.JS components -->
  <script type="text/ecmascript" src="vendor/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="vendor/three.min.js"></script>
  <script type="text/javascript" src="vendor/TrackballControls.js"></script>
  <script type="text/javascript" src="vendor/detector.min.js"></script>
  <script type="text/javascript" src="vendor/stats.min.js"></script>
  <script type="text/javascript" src="vendor/screenfull.min.js"></script>
</head>
<body>

  <!-- Container for the WebGL renderer -->
  <div id="container"></div>

  <!-- Overlayed on-screen heads up display -->
  <div id="hud">
    <div class="hud-panel" id="top-right">
      <a href="http://github.com/CoryG89/MoonDemo">Moon Demo</a> -- WebGL / JS
      <br />Created by <a href="http://coryg89.github.io/">Cory Gross</a>
    </div>
    <div class="hud-panel" id="bottom-right">
      <i>h</i> to toggle HUD - <i>p</i> for screenshot - <i>f</i> for fullscreen
    </div>
  </div>

  <!-- GLSL vertex shader for the moon -->
  <script id="vertexShader" type="x-shader/x-vertex">
        attribute vec4 tangent;
        
        uniform vec2 uvScale;
        uniform vec3 lightPosition;

        varying vec2 vUv;
        varying mat3 tbn;
        varying vec3 vLightVector;

        void main() {
            vUv = uvScale * uv;
            

            // Create the Tangent-Binormal-Normal Matrix used for transforming
            // coordinates from object space to tangent space
            vec3 vNormal = normalize(normalMatrix * normal);
            vec3 vTangent = normalize( normalMatrix * tangent.xyz );
            vec3 vBinormal = normalize(cross( vNormal, vTangent ) * tangent.w);
            tbn = mat3(vTangent, vBinormal, vNormal);
        
            // Calculate the Vertex-to-Light Vector 
            vec4 lightVector = viewMatrix * vec4(lightPosition, 1.0);
            vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);
            vLightVector = normalize(lightVector.xyz - modelViewPosition.xyz);
    
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
  </script>

  <!-- GLSL fragment shader for the moon -->
  <script id="fragmentShader" type="x-shader/x-fragment">
        uniform sampler2D textureMap;
        uniform sampler2D normalMap;
        
        varying vec2 vUv;
        varying mat3 tbn;
        varying vec3 vLightVector;
        
        void main() {
            // Transform texture coordinate of normal map to a range (-1.0, 1.0)
            vec3 normalCoordinate = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;

            // Transform the normal vector in the RGB channels to tangent space
            vec3 normal = normalize(tbn * normalCoordinate.rgb);

            // Intensity calculated as dot of normal and vertex-light vector
            float intensity = max(0.07, dot(normal, vLightVector));

            // Adjustments to alpha and intensity per color channel may be made
            vec4 lighting = vec4(intensity, intensity, intensity, 1.0);

            // Final color is calculated with the lighting applied
            gl_FragColor = texture2D(textureMap, vUv) * lighting;
        }
  </script>

  <script type="text/javascript" src="js/scene.js"></script>
</body>
</html>
